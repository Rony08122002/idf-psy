
import React, { useState, useEffect, useRef } from "react";
import { useLocation } from "react-router-dom";
import { Conversation } from "@/entities/Conversation";
import { User } from "@/entities/User";
import { InvokeLLM } from "@/integrations/Core";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Slider } from "@/components/ui/slider";
import { Badge } from "@/components/ui/badge";
import { 
  Send, 
  Mic, 
  MicOff, 
  Video, 
  VideoOff, 
  ArrowLeft,
  MessageCircle,
  Heart,
  AlertTriangle
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";

import ChatInterface from "../components/chat/ChatInterface";
import MoodSlider from "../components/chat/MoodSlider";
import AvatarDisplay from "../components/chat/AvatarDisplay";
import ConversationSummary from "../components/chat/ConversationSummary";

export default function Chat() {
  const location = useLocation();
  const navigate = useNavigate();
  const urlParams = new URLSearchParams(location.search);
  const mode = urlParams.get('mode') || 'text';
  
  const [user, setUser] = useState(null);
  const [messages, setMessages] = useState([]);
  const [currentMessage, setCurrentMessage] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [conversationStarted, setConversationStarted] = useState(false);
  const [moodScore, setMoodScore] = useState(5);
  const [isRecording, setIsRecording] = useState(false);
  const [conversationComplete, setConversationComplete] = useState(false);
  const [assessment, setAssessment] = useState(null);
  const messagesEndRef = useRef(null);

  useEffect(() => {
    initializeChat();
  }, []);

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  const initializeChat = async () => {
    try {
      const currentUser = await User.me();
      setUser(currentUser);
      
      // Start conversation with greeting
      const greeting = getGreetingMessage(mode);
      setMessages([{
        role: "assistant",
        content: greeting,
        timestamp: new Date().toISOString()
      }]);
      
    } catch (error) {
      console.error("Error initializing chat:", error);
    }
  };

  const getGreetingMessage = (mode) => {
    const modeGreetings = {
      text: "砖!    拽砖 转  .  转 专砖 注砖?",
      voice: "砖 砖!    转 砖 拽转. 拽 转  砖 住驻专   转 专砖 .",
      video: "专 !   转转 砖 转    转 .  拽 砖 驻  驻 注  转 专砖 ."
    };
    return modeGreetings[mode] || modeGreetings.text;
  };

  const sendMessage = async (message) => {
    if (!message.trim() || isLoading) return;

    const userMessage = {
      role: "user",
      content: message,
      timestamp: new Date().toISOString()
    };

    setMessages(prev => [...prev, userMessage]);
    setCurrentMessage("");
    setIsLoading(true);
    setConversationStarted(true);

    try {
      // Generate AI response in Hebrew
      const aiPrompt = `
        转  转转  转 专转 驻砖 注专 砖 爪 砖专.
        转 爪专 转 驻转,  拽爪注.
        
        砖 注 : ${JSON.stringify(messages)}
        砖转砖 专注 专: ${message}
        
        注 爪专 转转 注专转. 砖 砖转 砖    转专 转 爪 驻砖 砖.
        砖专 注 转转 拽爪专转  驻转转.  转  住 砖 爪拽 专爪转, 爪注 注转 注专 拽爪注转.
        
        注 驻 注 转 注专转.
      `;

      const response = await InvokeLLM({
        prompt: aiPrompt,
        add_context_from_internet: false
      });

      const assistantMessage = {
        role: "assistant",
        content: response,
        timestamp: new Date().toISOString()
      };

      setMessages(prev => [...prev, assistantMessage]);

    } catch (error) {
      console.error("Error generating response:", error);
      setMessages(prev => [...prev, {
        role: "assistant",
        content: "住, 砖  注  注砖. 住 砖 拽砖.",
        timestamp: new Date().toISOString()
      }]);
    } finally {
      setIsLoading(false);
    }
  };

  const endConversation = async () => {
    setIsLoading(true);
    
    try {
      // Generate assessment in Hebrew
      const assessmentPrompt = `
        转住住 注 砖  砖 专转 驻砖, 住驻拽 注专:
        
        注转: ${JSON.stringify(messages)}
        爪 爪 专 砖 砖转砖 (1-10): ${moodScore}
        
        转 转 砖 住驻拽:
        1. 拽专转 爪 专 转 (/专/砖)
        2. 专转 转 (/转/)
        3. 转 专砖 拽爪专
        4. 2-3 爪转 砖转砖
        
         拽爪注 转. 注 注专转.
      `;

      const assessmentResponse = await InvokeLLM({
        prompt: assessmentPrompt,
        response_json_schema: {
          type: "object",
          properties: {
            mood_category: { type: "string", enum: ["positive", "neutral", "negative"] },
            stress_level: { type: "string", enum: ["low", "medium", "high"] },
            sentiment_analysis: { type: "string" },
            recommendations: { type: "array", items: { type: "string" } }
          }
        }
      });

      const conversationData = {
        mode: mode,
        messages: messages,
        mood_assessment: {
          ...assessmentResponse,
          mood_score: moodScore
        },
        duration_minutes: Math.round((Date.now() - new Date(messages[0]?.timestamp).getTime()) / 60000),
        recommendations: assessmentResponse.recommendations || [],
        report_generated: false,
        report_shared: false
      };

      // Save conversation
      await Conversation.create(conversationData);
      
      setAssessment(assessmentResponse);
      setConversationComplete(true);
      
    } catch (error) {
      console.error("Error ending conversation:", error);
    } finally {
      setIsLoading(false);
    }
  };

  if (conversationComplete) {
    return (
      <ConversationSummary 
        assessment={assessment}
        moodScore={moodScore}
        duration={Math.round((Date.now() - new Date(messages[0]?.timestamp).getTime()) / 60000)}
        onNewConversation={() => navigate(createPageUrl("Dashboard"))}
      />
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 p-4 md:p-8" dir="rtl">
      <div className="max-w-4xl mx-auto">
        
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-4">
            <Button
              variant="outline"
              size="icon"
              onClick={() => navigate(createPageUrl("Dashboard"))}
            >
              <ArrowLeft className="w-4 h-4 scale-x-[-1]" />
            </Button>
            <div>
              <h1 className="text-2xl font-bold text-gray-900">
                砖转 {mode === 'text' ? '拽住' : mode === 'voice' ? '拽' : ''}
              </h1>
              <p className="text-gray-600">转 专转 驻砖  驻专转</p>
            </div>
          </div>
          <Badge variant="secondary" className="bg-green-100 text-green-800">
             爪驻 驻专
          </Badge>
        </div>

        <div className="grid lg:grid-cols-4 gap-6">
          
          {/* Chat Interface */}
          <div className="lg:col-span-3">
            <ChatInterface 
              messages={messages}
              currentMessage={currentMessage}
              setCurrentMessage={setCurrentMessage}
              onSendMessage={sendMessage}
              isLoading={isLoading}
              mode={mode}
              isRecording={isRecording}
              setIsRecording={setIsRecording}
              messagesEndRef={messagesEndRef}
            />
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            
            {/* Avatar Display for Video Mode */}
            {mode === 'video' && (
              <AvatarDisplay 
                isActive={conversationStarted}
                avatarType={user?.avatar_preference || 'male'}
              />
            )}

            {/* Mood Slider */}
            <MoodSlider 
              moodScore={moodScore}
              setMoodScore={setMoodScore}
            />

            {/* Quick Actions */}
            <Card className="border-none shadow-lg bg-white/90 backdrop-blur-sm">
              <CardHeader>
                <CardTitle className="text-sm">驻注转 专转</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                {messages.length > 2 && (
                  <Button
                    onClick={endConversation}
                    className="w-full bg-blue-600 hover:bg-blue-700"
                    disabled={isLoading}
                  >
                    砖 爪'拽-
                  </Button>
                )}
                
                <div className="text-xs text-gray-500 text-center">
                  <Heart className="w-4 h-4 inline ml-1" />
                   砖转  住转
                </div>
              </CardContent>
            </Card>

            {/* Emergency Support */}
            <Card className="border-red-200 shadow-lg bg-red-50">
              <CardContent className="p-4">
                <div className="flex items-center gap-2 text-red-700 mb-2">
                  <AlertTriangle className="w-4 h-4" />
                  <span className="font-semibold text-sm">转 砖专</span>
                </div>
                <p className="text-xs text-red-600 mb-3">
                   转 住 转  砖  砖转 注 驻注 注爪转
                </p>
                <Button size="sm" className="w-full bg-red-600 hover:bg-red-700 text-white">
                  拽 注专 注砖
                </Button>
              </CardContent>
            </Card>

          </div>
        </div>
      </div>
    </div>
  );
}
